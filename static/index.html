<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explain-Clean Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .spinner { border-top-color: transparent; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col">

    <header class="bg-white shadow-sm z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles text-blue-600 text-xl"></i>
                <h1 class="text-xl font-bold text-gray-900">Explain-Clean Tool</h1>
            </div>
            <div id="status-bar" class="hidden text-sm text-gray-500 font-medium bg-green-100 text-green-700 px-3 py-1 rounded-full fade-in">
                Session Active
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6">
        <div class="max-w-5xl mx-auto space-y-8">

            <!-- Upload Section -->
            <section id="upload-section" class="bg-white rounded-xl shadow-lg p-10 text-center transition-all duration-500 slide-up">
                <div id="drop-zone" class="border-4 border-dashed border-gray-200 rounded-lg p-12 cursor-pointer hover:border-blue-400 transition hover:bg-gray-50">
                    <i class="fa-solid fa-cloud-arrow-up text-6xl text-gray-300 mb-4 transition transform hover:scale-110"></i>
                    <h2 class="text-2xl font-semibold mb-2">Upload your Dataset</h2>
                    <p class="text-gray-500 mb-6">Drag & drop CSV files here, or click to browse</p>
                    <input type="file" id="file-input" class="hidden" accept=".csv">
                    <button type="button" onclick="document.getElementById('file-input').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition shadow-md">
                        Select File
                    </button>
                </div>
            </section>

            <!-- Loader -->
            <div id="loader" class="hidden flex flex-col items-center justify-center py-12 fade-in">
                <div class="spinner w-12 h-12 border-4 border-blue-600 rounded-full mb-4"></div>
                <p class="text-gray-600 animate-pulse font-medium">Analyzing data profile...</p>
            </div>

            <!-- Dashboard -->
            <section id="dashboard-section" class="hidden space-y-6 fade-in">

                <!-- Stats & Chart Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Stats Column -->
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500 transform transition hover:-translate-y-1">
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Rows</p>
                            <p class="text-3xl font-bold text-gray-800" id="stat-rows">-</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-purple-500 transform transition hover:-translate-y-1">
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Columns</p>
                            <p class="text-3xl font-bold text-gray-800" id="stat-cols">-</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-red-500 transform transition hover:-translate-y-1">
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Issues Detected</p>
                            <p class="text-3xl font-bold text-gray-800" id="stat-issues">-</p>
                        </div>

                        <!-- Insight Box -->
                        <div class="sm:col-span-3 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-lg p-6 shadow-lg text-white transform transition duration-500">
                            <div class="flex items-start gap-4">
                                <div class="bg-white/20 p-3 rounded-full shadow-inner"><i class="fa-solid fa-robot text-2xl"></i></div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg mb-1">Data Insight</h3>
                                    <p id="ai-insight-text" class="text-blue-50 text-sm leading-relaxed mb-4 opacity-90 font-light">Analyzing...</p>
                                    <div id="ai-actions" class="hidden">
                                        <button type="button" onclick="applyAiPlan()" class="bg-white text-blue-600 px-5 py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-50 hover:shadow-lg transition transform hover:-translate-y-0.5">
                                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Review Recommended Plan
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Column -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex flex-col items-center justify-center relative">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Data Health Score</h3>
                        <div class="relative w-full h-48">
                            <canvas id="healthChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Issues List -->
                <div id="issues-container" class="space-y-4"></div>

                <!-- Footer Action -->
                <div class="sticky bottom-4 z-20 flex justify-end">
                    <button type="button" onclick="applyFixes()" class="bg-green-600 text-white px-8 py-4 rounded-xl font-bold shadow-xl hover:bg-green-700 transition transform hover:-translate-y-1 flex items-center gap-2">
                        <span>Apply Fixes & Re-Analyze</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </section>

            <!-- Final Report -->
            <section id="report-section" class="hidden bg-white rounded-xl shadow-lg p-12 fade-in">
                <div class="text-center mb-10">
                    <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm animate-bounce">
                        <i class="fa-solid fa-check text-4xl"></i>
                    </div>
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Cleaning Complete!</h2>
                    <p class="text-gray-500 text-lg">Your dataset is now spotless and ready for analysis.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div>
                        <h3 class="font-bold text-xl text-gray-800 mb-4 border-b pb-2">Session Audit Log</h3>
                        <ul id="audit-log" class="text-sm text-gray-600 space-y-3 max-h-80 overflow-y-auto custom-scrollbar pr-2"></ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-gray-800 mb-4 border-b pb-2">Visualization Ready</h3>
                        <div id="chart-recs" class="flex flex-wrap gap-3"></div>
                    </div>
                </div>
                <div class="mt-12 text-center flex justify-center gap-4">
                    <a id="download-btn" href="#" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition transform hover:-translate-y-1 flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> Download Final CSV
                    </a>
                    <button type="button" onclick="location.reload()" class="bg-gray-100 text-gray-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-200 transition">Start New Session</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Detailed Plan Modal -->
    <div id="plan-details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 m-4 transform scale-95 transition-transform duration-300" id="modal-panel">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">Optimization Plan</h3>
                    <p class="text-sm text-gray-500 mt-1">Reviewing proposed changes</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="space-y-3 max-h-[50vh] overflow-y-auto custom-scrollbar pr-2" id="plan-details-content">
                <!-- Dynamic Content -->
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-5 py-2 text-gray-600 font-medium hover:bg-gray-50 rounded-lg transition">Cancel</button>
                <button onclick="closeModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-md">
                    Confirm & Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-y-32 transition-transform duration-500 z-50 flex items-center gap-3">
        <i class="fa-solid fa-info-circle text-blue-400"></i>
        <span id="toast-msg" class="font-medium">Notification</span>
    </div>

    <script>
        let sessionData = null;
        let sessionId = null;
        let currentAiPlan = [];
        let healthChart = null;
        let fullAuditLog = [];

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
        });
        dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        function handleFiles(files) {
            if (files.length > 0) uploadFile(files[0]);
        }

        async function uploadFile(file) {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                if(!response.ok) throw new Error("Upload failed");
                sessionData = await response.json();
                sessionId = sessionData.session_id;
                document.getElementById('status-bar').classList.remove('hidden');
                renderDashboard();
                await fetchAiInsights();
            } catch (error) {
                alert("Upload failed. Please check backend logs.");
                location.reload();
            }
        }

        function renderDashboard() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');

            document.getElementById('stat-rows').innerText = sessionData.total_rows.toLocaleString();
            document.getElementById('stat-cols').innerText = sessionData.total_columns;
            document.getElementById('stat-issues').innerText = sessionData.issues.length;

            renderHealthChart();

            const container = document.getElementById('issues-container');
            container.innerHTML = '';

            if(sessionData.issues.length === 0) {
                 container.innerHTML = '<div class="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">No issues found. You can download your data now.</div>';
            }

            sessionData.issues.forEach((issue, index) => {
                const card = document.createElement('div');
                card.className = `bg-white border-l-4 ${getSeverityColor(issue.severity)} rounded-r-xl shadow-sm p-6 slide-up`;
                card.style.animationDelay = `${index * 0.1}s`; // Staggered animation
                card.id = `card-${issue.id}`;

                let optionsHtml = issue.strategies.map(s =>
                    `<option value="${s.action_code}">${s.name}</option>`
                ).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="px-3 py-1 text-xs font-bold rounded-full uppercase ${getSeverityBg(issue.severity)} mb-2 inline-block shadow-sm tracking-wide">${issue.severity}</span>
                            <span class="ml-2 text-xs text-gray-500 font-bold uppercase tracking-wider">${issue.type}</span>
                            <h3 class="text-lg font-bold text-gray-800 mt-1">${issue.description}</h3>
                            <p class="text-sm text-gray-600 mt-2 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-500"></i> ${issue.impact}</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between border border-gray-100">
                        <div class="text-sm text-gray-600">
                            <strong class="text-gray-800">Recommended Action:</strong>
                            <p class="text-xs text-gray-500 mt-0.5">${issue.strategies[0].description}</p>
                        </div>
                        <select id="select-${issue.id}" class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm cursor-pointer">
                            ${optionsHtml}
                        </select>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderHealthChart() {
            const ctx = document.getElementById('healthChart').getContext('2d');

            let issueCounts = {};
            let totalAffectedRows = 0;
            sessionData.issues.forEach(issue => {
                if (!issueCounts[issue.type]) issueCounts[issue.type] = 0;
                issueCounts[issue.type] += issue.row_count;
                totalAffectedRows += issue.row_count;
            });

            let cleanRows = Math.max(0, sessionData.total_rows - totalAffectedRows);
            if (totalAffectedRows > sessionData.total_rows) cleanRows = 0;

            const data = {
                labels: ['Clean', ...Object.keys(issueCounts)],
                datasets: [{
                    data: [cleanRows, ...Object.values(issueCounts)],
                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5CF6', '#EC4899'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11, family: 'sans-serif' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: { enabled: false }
                    }
                }
            };

            if (healthChart) healthChart.destroy();
            healthChart = new Chart(ctx, config);
        }

        async function applyFixes() {
            const fixes = sessionData.issues.map(issue => ({
                issue_id: issue.id,
                strategy_code: document.getElementById(`select-${issue.id}`).value
            }));

            const res = await fetch(`/api/session/${sessionId}/clean`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ fixes })
            });
            const report = await res.json();

            fullAuditLog = [...fullAuditLog, ...report.actions_taken];

            if (report.remaining_issues.length > 0) {
                sessionData.issues = report.remaining_issues;
                sessionData.total_rows = report.rows_after;
                renderDashboard();
                showToast(`Cycle complete. ${report.remaining_issues.length} issues remaining.`);
                fetchAiInsights();
            } else {
                showReport(report);
            }
        }

        function showReport(report) {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('report-section').classList.remove('hidden');

            const log = document.getElementById('audit-log');
            log.innerHTML = fullAuditLog.map((a, i) =>
                `<li class="border-b border-gray-100 py-3 flex items-start gap-3 slide-up" style="animation-delay: ${i*0.05}s">
                    <i class="fa-solid fa-check-circle text-green-500 mt-1"></i>
                    <span class="text-gray-700">${a}</span>
                </li>`
            ).join('');

            const recs = document.getElementById('chart-recs');
            recs.innerHTML = report.chart_recommendations.map(r =>
                `<span class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm font-semibold border border-blue-100 shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-chart-simple"></i> ${r}
                </span>`
            ).join('');

            document.getElementById('download-btn').href = report.download_url;
        }

        function getSeverityColor(sev) { return sev === 'High' ? 'border-red-500' : sev === 'Medium' ? 'border-yellow-500' : 'border-blue-500'; }
        function getSeverityBg(sev) { return sev === 'High' ? 'bg-red-100 text-red-800' : sev === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'; }

        async function fetchAiInsights() {
            try {
                const res = await fetch(`/api/session/${sessionId}/analyze`);
                const data = await res.json();
                document.getElementById('ai-insight-text').innerText = data.insight;
                currentAiPlan = data.recommended_actions;
                if (currentAiPlan.length > 0) document.getElementById('ai-actions').classList.remove('hidden');
                else document.getElementById('ai-actions').classList.add('hidden');
            } catch (err) { console.error(err); }
        }

        function applyAiPlan() {
            const list = document.getElementById('plan-details-content');
            list.innerHTML = '';
            currentAiPlan.forEach(action => {
                const select = document.getElementById(`select-${action.issue_id}`);
                if (select) {
                    select.value = action.strategy_code;
                    const issue = sessionData.issues.find(i => i.id === action.issue_id);
                    if (issue) {
                        const div = document.createElement('div');
                        div.className = "flex items-start gap-3 p-4 bg-gray-50 rounded-xl border border-gray-100 transition hover:bg-white hover:shadow-sm";
                        div.innerHTML = `
                            <div class="mt-1 flex-shrink-0 bg-green-100 text-green-600 rounded-full w-6 h-6 flex items-center justify-center">
                                <i class="fa-solid fa-check text-xs"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">${issue.description}</p>
                                <p class="text-xs text-blue-600 mt-1 font-medium bg-blue-50 inline-block px-2 py-0.5 rounded">Action: ${action.strategy_code}</p>
                            </div>
                        `;
                        list.appendChild(div);
                    }
                }
            });
            openModal();
        }

        function openModal() {
            const modal = document.getElementById('plan-details-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); panel.classList.remove('scale-95'); panel.classList.add('scale-100'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('plan-details-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.add('opacity-0');
            panel.classList.remove('scale-100');
            panel.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        }
    </script>
</body>
</html>